<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test integration with FetchStudent</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="loader">
        <div id="box"></div>
        <div id="hill"></div>

    </div>
    <p class="borrowed">Preloader by <a href="https://codepen.io/pawelqcm/">Pawel</a></p>
    <div id="sorting">
        <button data-sort="total" data-sorttype="number">Total</button>
        <button data-sort="fullname" data-sorttype="string">Full name</button>
    </div>

    <div id="app">

    </div>
    <template id="student">
        <article class="student">
            <h1></h1>
            <h2>Total: <span></span></h2>
            <button>more</button>
            <ul class="stats hidden">

            </ul>
        </article>
    </template>
    <script src="classes/FetchStudent.js"></script>
    <script src="data/challenges.js"></script>
    <script src="classes/FetchGoogleJSON.js"></script>
    <script src="classes/PrettifyGoogleJSON.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.20.2/TweenMax.min.js"></script>
    <script>
        
        let fgd = new FetchGoogleJSON("16gLcoH7n58y9X9afCWzeB84VURmTznS6PByJwwS4BJE", listLoaded);
        let timer=null;
        let students = [];
        function listLoaded(data){
            number = data.length;
            data.forEach(student=>{
                new FetchStudent(student, challenges, showStudent);
            });
        }

        function showStudent(student, scores){
            let template = document.querySelector("#student").content;
            let clone = template.cloneNode(true);
            let studentElem = clone.querySelector('.student');
            studentElem.dataset.fullname=student.fullname;

            clone.querySelector('h1').textContent=student.fullname + " @"+student.codecamphandle;
            let total = 0;
            for(let k in scores){
                total+=scores[k];
                let li = document.createElement('li');
                li.textContent = k + ": " + scores[k];
                let plain = k.replace(/ /gi, '').toLowerCase();
                studentElem.dataset[plain] = scores[k];
                clone.querySelector('.stats').appendChild(li);
                let b = document.querySelector('button[data-sort="'+plain+'"]');
                if(!b){
                    let button = document.createElement('button');
                    button.textContent=k;
                    button.dataset.sort=plain;
                    button.dataset.sorttype="number";
                    document.querySelector("#sorting").appendChild(button);
                }
            }
            clone.querySelector('h2 span').textContent=total;
            studentElem.dataset.total=total;
            clone.querySelector('button').addEventListener('click',(e)=>e.target.nextElementSibling.classList.toggle('hidden'))
            //document.querySelector('#app').appendChild(clone);
            students.push(studentElem);
            clearTimeout(timer);
            timer = setTimeout(sort, 2000);
        }

        function sort(){
            document.querySelector("#loader").classList.add("hidden");
            document.querySelector(".borrowed").classList.add("hidden");
            //let all = [...document.querySelectorAll('.student')];
            students.sort(sortNames);
            setupListeners();
            students.forEach(s=>{
                //s.classList.add("hidden");
                document.querySelector("#app").appendChild(s);
                //let x = TweenMax.fromTo(s, 1.5, {x:0, y: -2000}, {x:0, y:0, display:'block'});
            });
        }
        function sortNames(a,b){
            let nameA = a.dataset.fullname.toUpperCase();
            let nameB = b.dataset.fullname.toUpperCase();
            if (nameA < nameB) {
                return -1;
            }
            if (nameA > nameB) {
                return 1;
            }
            return 0;
        }
        function setupListeners(){
            document.querySelectorAll('button[data-sort]').forEach(b=>{//TODO, targeter ogsÃ¥ buttons in students, kun dem med sort attribut
                b.addEventListener('click', (e)=>{
                    let sort = e.target.dataset.sort;
                    let sorttype= e.target.dataset.sorttype;

                    let all = [...document.querySelectorAll('.student')];
                    if(sorttype==="number"){
                        all.sort((a,b)=>b.dataset[sort] - a.dataset[sort]);
                    } else {
                        all.sort(sortNames);
                    }

                    all.forEach((s,i)=>{
                        console.log(s.dataset[sort])
                        let row = Math.floor(i/3);//not very responsive
                        let remainder = i % 3;
                        let mod = window.innerWidth / 3;
                        let x = TweenMax.to(s, 1.5, {x:remainder * mod + 10 - s.offsetLeft, y: row*210+29-s.offsetTop});
                    })
                    setTimeout(()=>{
                        all.forEach(a=>{
                            a.style="";
                            document.querySelector("#app").appendChild(a)
                        })
                    }, 1600);
                })
            })
        }
    </script>
</body>
</html>